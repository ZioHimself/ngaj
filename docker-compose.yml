# ngaj Production Docker Compose Configuration
# Usage: docker compose up -d
#
# Services:
# - mongodb: Database for profiles, accounts, opportunities, responses
# - chromadb: Vector database for knowledge base embeddings
# - backend: ngaj API server (includes frontend static files)
#
# Prerequisites:
# - ~/.ngaj/.env must exist with credentials (created by setup wizard)
# - Docker Desktop running
#
# Data Storage:
# - Uses named volumes (managed by Docker) for better security and performance
# - To backup: docker run --rm -v ngaj-mongodb:/data -v $(pwd):/backup alpine tar cvf /backup/mongo.tar /data
# - To use bind mounts instead, create docker-compose.override.yml

services:
  mongodb:
    image: mongo:7
    container_name: ngaj-mongodb
    restart: unless-stopped
    volumes:
      - ngaj-mongodb:/data/db
    networks:
      - ngaj-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  chromadb:
    image: chromadb/chroma:latest
    container_name: ngaj-chromadb
    restart: unless-stopped
    volumes:
      - ngaj-chromadb:/chroma/chroma
    networks:
      - ngaj-network
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/8000'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  backend:
    image: ziohimself/ngaj-backend:stable
    container_name: ngaj-backend
    restart: unless-stopped
    ports:
      - "3000:3000"
    env_file:
      - ${HOME}/.ngaj/.env
    environment:
      - NODE_ENV=production
      - MONGODB_URI=mongodb://mongodb:27017/ngaj
      - CHROMA_URL=http://chromadb:8000
    depends_on:
      mongodb:
        condition: service_healthy
      chromadb:
        condition: service_healthy
    networks:
      - ngaj-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  ngaj-network:
    driver: bridge

volumes:
  ngaj-mongodb:
  ngaj-chromadb:
