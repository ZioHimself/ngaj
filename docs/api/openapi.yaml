openapi: 3.0.3
info:
  title: ngaj API
  description: |
    RESTful API for ngaj - Proactive engagement companion for social media.
    
    ngaj helps you discover relevant conversations, generate AI-powered responses
    grounded in your knowledge base, and maintain authentic presence across social platforms.
    
    ## Authentication
    v0.1 uses environment variables for credentials. No API authentication required.
    Future versions will implement proper authentication.
    
    ## Rate Limiting
    Currently no rate limiting. Future versions will implement rate limits per endpoint.
  version: 0.1.0
  contact:
    name: ngaj Development Team
  license:
    name: MIT

servers:
  - url: http://localhost:3000/api
    description: Local development server
  - url: http://localhost:3000/api
    description: Production server (future)

tags:
  - name: Account
    description: Account configuration and management
  - name: Opportunities
    description: Discovered engagement opportunities
  - name: Knowledge
    description: Knowledge base management
  - name: Responses
    description: AI-generated response management
  - name: System
    description: System health and statistics

paths:
  # ==================== Account Endpoints ====================
  /account:
    get:
      tags:
        - Account
      summary: Get account configuration
      description: Retrieve the current account configuration including discovery settings, voice preferences, and platform connections
      operationId: getAccount
      responses:
        '200':
          description: Account configuration retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              example:
                success: true
                data:
                  _id: "507f1f77bcf86cd799439011"
                  name: "My Tech Commentary Account"
                  discovery:
                    interests: ["AI", "TypeScript"]
                    schedules:
                      - type: "replies"
                        enabled: true
                        cronExpression: "*/15 * * * *"
                      - type: "search"
                        enabled: true
                        cronExpression: "0 */2 * * *"
                  voice:
                    tonePreset: "technical"
                    customInstructions: "Always cite sources"
                  platforms:
                    - platform: "bluesky"
                      handle: "mytech.bsky.social"
                      isActive: true
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    put:
      tags:
        - Account
      summary: Update account configuration
      description: Update account settings including discovery preferences and voice configuration
      operationId: updateAccount
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAccountRequest'
      responses:
        '200':
          description: Account updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ==================== Opportunity Endpoints ====================
  /opportunities:
    get:
      tags:
        - Opportunities
      summary: List opportunities
      description: Retrieve a paginated list of discovered engagement opportunities
      operationId: listOpportunities
      parameters:
        - name: status
          in: query
          description: Filter by opportunity status
          schema:
            type: string
            enum: [pending, reviewed, responded, skipped, expired]
            default: pending
        - name: limit
          in: query
          description: Maximum number of results to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: Number of results to skip (pagination)
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: sort
          in: query
          description: Sort field and direction
          schema:
            type: string
            enum: [score, -score, discoveredAt, -discoveredAt]
            default: -score
      responses:
        '200':
          description: Opportunities retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/PaginatedOpportunities'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /discovery/run:
    post:
      tags:
        - Opportunities
      summary: Trigger manual discovery
      description: |
        Manually trigger opportunity discovery for the configured account.
        Runs both 'replies' and 'search' discovery types if enabled.
        Used by the dashboard refresh button for on-demand discovery.
        
        @see ADR-008: Opportunity Discovery Architecture
        @see GitHub Issue #34
      operationId: triggerDiscoveryRun
      responses:
        '200':
          description: Discovery completed successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - discoveredCount
                  - repliesCount
                  - searchCount
                properties:
                  discoveredCount:
                    type: integer
                    description: Total opportunities discovered (replies + search)
                    example: 5
                  repliesCount:
                    type: integer
                    description: Opportunities discovered from replies
                    example: 3
                  searchCount:
                    type: integer
                    description: Opportunities discovered from search
                    example: 2
                  message:
                    type: string
                    description: Optional message (e.g., "No account configured")
              examples:
                success:
                  summary: Successful discovery
                  value:
                    discoveredCount: 5
                    repliesCount: 3
                    searchCount: 2
                noAccount:
                  summary: No account configured
                  value:
                    discoveredCount: 0
                    repliesCount: 0
                    searchCount: 0
                    message: "No account configured"
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
        '500':
          description: Discovery service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
              example:
                error: "Discovery service not available"
                message: "Bluesky credentials not configured"

  /opportunities/{id}:
    get:
      tags:
        - Opportunities
      summary: Get opportunity details
      description: Retrieve full details for a specific opportunity including thread context
      operationId: getOpportunity
      parameters:
        - name: id
          in: path
          required: true
          description: Opportunity ID
          schema:
            type: string
      responses:
        '200':
          description: Opportunity retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Opportunity'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    patch:
      tags:
        - Opportunities
      summary: Update opportunity status
      description: Update the status of an opportunity (e.g., mark as reviewed or skipped)
      operationId: updateOpportunityStatus
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: string
                  enum: [reviewed, skipped]
      responses:
        '200':
          description: Opportunity status updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== Knowledge Endpoints ====================
  /knowledge:
    get:
      tags:
        - Knowledge
      summary: List knowledge documents
      description: Retrieve a list of uploaded knowledge base documents
      operationId: listKnowledge
      parameters:
        - name: category
          in: query
          description: Filter by document category
          schema:
            type: string
            enum: [reference, voice_sample, argument_template]
        - name: tags
          in: query
          description: Comma-separated tags to filter by
          schema:
            type: string
        - name: status
          in: query
          description: Filter by processing status
          schema:
            type: string
            enum: [pending, processing, processed, failed]
      responses:
        '200':
          description: Knowledge documents retrieved
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          documents:
                            type: array
                            items:
                              $ref: '#/components/schemas/KnowledgeDocument'
                          total:
                            type: integer

  /knowledge/upload:
    post:
      tags:
        - Knowledge
      summary: Upload knowledge document
      description: Upload a new document to the knowledge base
      operationId: uploadKnowledge
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - category
              properties:
                file:
                  type: string
                  format: binary
                  description: Document file (PDF, MD, TXT, DOCX)
                category:
                  type: string
                  enum: [reference, voice_sample, argument_template]
                tags:
                  type: array
                  items:
                    type: string
                title:
                  type: string
                description:
                  type: string
      responses:
        '201':
          description: Document uploaded successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/KnowledgeDocument'
        '400':
          $ref: '#/components/responses/BadRequest'
        '413':
          description: File too large
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'

  /knowledge/{id}:
    get:
      tags:
        - Knowledge
      summary: Get knowledge document details
      description: Retrieve details for a specific knowledge document
      operationId: getKnowledgeDocument
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Document retrieved
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/KnowledgeDocument'
        '404':
          $ref: '#/components/responses/NotFound'
    
    delete:
      tags:
        - Knowledge
      summary: Delete knowledge document
      description: Delete a knowledge document and its associated embeddings
      operationId: deleteKnowledgeDocument
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Document deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              example:
                success: true
                data:
                  deleted: true
                  chunksDeleted: 42
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== Response Endpoints ====================
  /responses:
    get:
      tags:
        - Responses
      summary: List responses by opportunity IDs
      description: |
        Retrieve responses for multiple opportunities in a single request.
        Returns the latest version of each response (highest version number).
        Used by the dashboard to batch-load responses for a page of opportunities.
      operationId: listResponsesByOpportunities
      parameters:
        - name: opportunityIds
          in: query
          required: true
          description: Comma-separated list of opportunity IDs
          schema:
            type: string
          example: "507f1f77bcf86cd799439011,507f1f77bcf86cd799439012"
      responses:
        '200':
          description: Responses retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          responses:
                            type: array
                            items:
                              $ref: '#/components/schemas/Response'
              example:
                success: true
                data:
                  responses:
                    - _id: "507f1f77bcf86cd799439014"
                      opportunityId: "507f1f77bcf86cd799439011"
                      status: "draft"
                      suggestedText: "Great point about..."
                      finalText: "Great point about..."
                      version: 1
        '400':
          $ref: '#/components/responses/BadRequest'

  /responses/generate:
    post:
      tags:
        - Responses
      summary: Generate AI response
      description: Generate an AI-powered response for a specific opportunity
      operationId: generateResponse
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateResponseRequest'
      responses:
        '200':
          description: Response generated successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Response'
        '404':
          $ref: '#/components/responses/NotFound'
        '503':
          description: AI API unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'

  /responses/{id}:
    get:
      tags:
        - Responses
      summary: Get response details
      description: Retrieve details for a specific generated response
      operationId: getResponse
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Response retrieved
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Response'
        '404':
          $ref: '#/components/responses/NotFound'
    
    patch:
      tags:
        - Responses
      summary: Edit response text
      description: Modify the response text before posting
      operationId: editResponse
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - finalText
              properties:
                finalText:
                  type: string
                  description: Modified response text
      responses:
        '200':
          description: Response updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /responses/{id}/post:
    post:
      tags:
        - Responses
      summary: Post response to platform
      description: Post the generated response to the social media platform
      operationId: postResponse
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                text:
                  type: string
                  description: Optional override text
      responses:
        '200':
          description: Response posted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              example:
                success: true
                data:
                  _id: "507f1f77bcf86cd799439014"
                  status: "posted"
                  postedAt: "2025-12-27T12:16:00Z"
                  postUri: "at://did:plc:user123/app.bsky.feed.post/reply456"
                  postUrl: "https://bsky.app/profile/mytech.bsky.social/post/reply456"
        '400':
          description: Response already posted or invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
        '404':
          $ref: '#/components/responses/NotFound'
        '503':
          description: Platform API unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'

  # ==================== System Endpoints ====================
  /health:
    get:
      tags:
        - System
      summary: Health check
      description: Check the health status of the service and its dependencies
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              example:
                success: true
                data:
                  status: "healthy"
                  timestamp: "2025-12-27T12:00:00Z"
                  services:
                    mongodb: "connected"
                    chromadb: "connected"
                    bluesky: "authenticated"
                    claude: "available"
                  version: "0.1.0"

  /stats:
    get:
      tags:
        - System
      summary: Get usage statistics
      description: Retrieve usage statistics for the account
      operationId: getStats
      responses:
        '200':
          description: Statistics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              example:
                success: true
                data:
                  opportunities:
                    total: 127
                    pending: 15
                    responded: 42
                  knowledge:
                    documents: 8
                    totalChunks: 342
                  responses:
                    total: 42
                    posted: 38
                    drafts: 4

# ==================== Components ====================
components:
  schemas:
    # Common response wrapper
    ApiResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          description: Whether the request was successful
        data:
          type: object
          description: Response data (varies by endpoint)
        error:
          $ref: '#/components/schemas/ApiError'

    ApiError:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Error code
          example: VALIDATION_ERROR
        message:
          type: string
          description: Human-readable error message
          example: Invalid request parameters
        details:
          type: object
          description: Additional error details

    # Account schemas
    Account:
      type: object
      required:
        - _id
        - name
        - discovery
        - voice
        - platforms
      properties:
        _id:
          type: string
          description: Account ID
        name:
          type: string
          description: Account display name
        discovery:
          $ref: '#/components/schemas/DiscoveryConfig'
        voice:
          $ref: '#/components/schemas/VoiceConfig'
        platforms:
          type: array
          items:
            $ref: '#/components/schemas/PlatformConnection'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    DiscoveryConfig:
      type: object
      required:
        - interests
        - schedules
      properties:
        interests:
          type: array
          items:
            type: string
          description: Topics of interest
        schedules:
          type: array
          description: Array of typed discovery schedules (one per discovery type). Per ADR-008, accounts have multiple independent schedules.
          minItems: 1
          items:
            $ref: '#/components/schemas/DiscoveryTypeSchedule'
        lastAt:
          type: string
          format: date-time
          description: Last successful discovery (any type)
        error:
          type: string
          description: Last discovery error message
    
    DiscoveryTypeSchedule:
      type: object
      required:
        - type
        - enabled
        - cronExpression
      properties:
        type:
          type: string
          enum: [replies, search]
          description: Discovery source type
        enabled:
          type: boolean
          description: Whether this discovery type is enabled
        cronExpression:
          type: string
          description: Cron expression for this discovery type
          example: "*/15 * * * *"
        lastRunAt:
          type: string
          format: date-time
          description: When this specific discovery type last ran

    VoiceConfig:
      type: object
      required:
        - tonePreset
      properties:
        tonePreset:
          type: string
          enum: [professional, casual, technical, custom]
        customInstructions:
          type: string
          description: Custom prompt instructions
        examples:
          type: array
          items:
            type: string
          description: Knowledge document IDs used as voice samples

    PlatformConnection:
      type: object
      required:
        - platform
        - handle
        - isActive
      properties:
        platform:
          type: string
          enum: [bluesky, linkedin, reddit]
        handle:
          type: string
          description: Platform username/handle
        isActive:
          type: boolean
        connectedAt:
          type: string
          format: date-time

    UpdateAccountRequest:
      type: object
      properties:
        name:
          type: string
        discovery:
          $ref: '#/components/schemas/DiscoveryConfig'
        voice:
          $ref: '#/components/schemas/VoiceConfig'

    # Opportunity schemas
    Opportunity:
      type: object
      required:
        - _id
        - accountId
        - platform
        - post
        - discoveredAt
        - score
        - status
      properties:
        _id:
          type: string
        accountId:
          type: string
        platform:
          type: string
          enum: [bluesky, linkedin, reddit]
        post:
          $ref: '#/components/schemas/Post'
        discoveredAt:
          type: string
          format: date-time
        score:
          type: number
          format: float
          minimum: 0
          maximum: 10
        scoringFactors:
          type: object
          properties:
            impactScore:
              type: number
            timeScore:
              type: number
            keywordMatches:
              type: array
              items:
                type: string
        status:
          type: string
          enum: [pending, reviewed, responded, skipped, expired]
        reviewedAt:
          type: string
          format: date-time
        responseId:
          type: string
        threadContext:
          type: object
          properties:
            parentPosts:
              type: array
              items:
                type: string
            siblingPosts:
              type: array
              items:
                type: string

    Post:
      type: object
      required:
        - uri
        - url
        - authorHandle
        - authorDisplayName
        - authorFollowerCount
        - text
        - createdAt
      properties:
        uri:
          type: string
          description: Platform-specific post URI
        url:
          type: string
          description: Human-readable URL
        authorHandle:
          type: string
        authorDisplayName:
          type: string
        authorFollowerCount:
          type: integer
        text:
          type: string
        createdAt:
          type: string
          format: date-time
        inReplyTo:
          type: string
        hasMedia:
          type: boolean

    PaginatedOpportunities:
      type: object
      required:
        - opportunities
        - total
        - limit
        - offset
      properties:
        opportunities:
          type: array
          items:
            $ref: '#/components/schemas/Opportunity'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer
        hasMore:
          type: boolean

    # Knowledge schemas
    KnowledgeDocument:
      type: object
      required:
        - _id
        - accountId
        - fileName
        - fileType
        - fileSize
        - uploadedAt
        - category
        - processingStatus
      properties:
        _id:
          type: string
        accountId:
          type: string
        fileName:
          type: string
        fileType:
          type: string
          enum: [pdf, md, txt, docx]
        filePath:
          type: string
        fileSize:
          type: integer
          description: File size in bytes
        uploadedAt:
          type: string
          format: date-time
        category:
          type: string
          enum: [reference, voice_sample, argument_template]
        tags:
          type: array
          items:
            type: string
        processingStatus:
          type: string
          enum: [pending, processing, processed, failed]
        processedAt:
          type: string
          format: date-time
        processingError:
          type: string
        chromaCollectionId:
          type: string
        chunkCount:
          type: integer
        title:
          type: string
        description:
          type: string

    # Response schemas
    Response:
      type: object
      required:
        - _id
        - accountId
        - opportunityId
        - suggestedText
        - finalText
        - status
        - generatedAt
      properties:
        _id:
          type: string
        accountId:
          type: string
        opportunityId:
          type: string
        suggestedText:
          type: string
          description: AI-generated suggestion
        finalText:
          type: string
          description: Final text (may be edited)
        wasEdited:
          type: boolean
        knowledgeContext:
          type: object
          properties:
            documentsUsed:
              type: array
              items:
                type: string
            relevantChunks:
              type: array
              items:
                type: object
                properties:
                  documentId:
                    type: string
                  chunkId:
                    type: string
                  text:
                    type: string
                  similarity:
                    type: number
        modelUsed:
          type: string
          example: "claude-sonnet-4.5-20250929"
        promptTokens:
          type: integer
        completionTokens:
          type: integer
        generatedAt:
          type: string
          format: date-time
        postedAt:
          type: string
          format: date-time
        postUri:
          type: string
        postUrl:
          type: string
        status:
          type: string
          enum: [draft, posted, failed]
        error:
          type: string

    GenerateResponseRequest:
      type: object
      required:
        - opportunityId
        - mode
      properties:
        opportunityId:
          type: string
          description: ID of the opportunity to respond to
        mode:
          type: string
          enum: [quick]
          description: Response generation mode (v0.1 only supports 'quick')

  responses:
    BadRequest:
      description: Bad request - validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
          example:
            success: false
            error:
              code: "VALIDATION_ERROR"
              message: "Invalid request parameters"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
          example:
            success: false
            error:
              code: "NOT_FOUND"
              message: "Resource not found"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
          example:
            success: false
            error:
              code: "INTERNAL_ERROR"
              message: "An unexpected error occurred"

  securitySchemes:
    # Future: API Key authentication
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key authentication (future versions)

# No security required for v0.1
security: []
